<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>推送通知管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/css/shared-styles.css">
    <link rel="stylesheet" href="/static/css/push-notification-styles.css">
    <style>
        .channel-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .channel-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .config-section {
            margin-bottom: 1.5rem;
        }
        .config-section h6 {
            margin-bottom: 0.75rem;
        }
        .test-button {
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="navbar-container"></div>
        
        <div class="container mt-4">
            <h1 class="mb-4">推送通知管理</h1>
            
            <!-- 系统状态提示 -->
            <div v-if="isLoading" class="alert alert-info alert-dismissible fade show" role="alert">
                <div class="d-flex align-items-center">
                    <span class="spinner-border spinner-border-sm me-2"></span>
                    <div>
                        <strong>加载中</strong>
                        <br>
                        <span>{{ loadingMessage }}</span>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <!-- 左侧配置区域 -->
                <div class="col-lg-6 col-md-12">
                    <!-- 推送配置 -->
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">推送渠道配置</h5>
                        </div>
                        <div class="card-body">
                            <!-- 添加新渠道 -->
                            <div class="mb-4 p-3 border rounded bg-light">
                                <h6 class="mb-3">添加新推送渠道</h6>
                                <div class="mb-3">
                                    <label for="channel-type" class="form-label">渠道类型</label>
                                    <select id="channel-type" class="form-select" v-model="newChannel.type">
                                        <option value="" disabled>选择渠道类型</option>
                                        <option value="telegram">Telegram</option>
                                        <option value="wechat">企业微信</option>
                                    </select>
                                </div>
                                
                                <!-- Telegram配置 -->
                                <div v-if="newChannel.type === 'telegram'" class="telegram-config">
                                    <div class="mb-3">
                                        <label for="telegram-bot-token" class="form-label">Bot Token</label>
                                        <input type="text" id="telegram-bot-token" class="form-control" v-model="newChannel.config.bot_token" placeholder="Telegram Bot Token">
                                    </div>
                                    <div class="mb-3">
                                        <label for="telegram-chat-id" class="form-label">Chat ID</label>
                                        <input type="text" id="telegram-chat-id" class="form-control" v-model="newChannel.config.chat_id" placeholder="Telegram Chat ID">
                                    </div>
                                </div>
                                
                                <!-- 企业微信配置 -->
                                <div v-if="newChannel.type === 'wechat'" class="wechat-config">
                                    <div class="mb-3">
                                        <label for="wechat-webhook-url" class="form-label">Webhook URL</label>
                                        <input type="text" id="wechat-webhook-url" class="form-control" v-model="newChannel.config.webhook_url" placeholder="企业微信Webhook URL">
                                    </div>
                                </div>
                                
                                <button class="btn btn-success w-100" @click="addChannel" :disabled="!canAddChannel">
                                    <i class="bi bi-plus me-1"></i> 添加渠道
                                </button>
                            </div>
                            
                            <!-- 消息测试 -->
                            <div class="mb-4 p-3 border rounded bg-light">
                                <h6 class="mb-3">消息测试</h6>
                                <div class="mb-3">
                                    <label for="test-message" class="form-label">测试消息</label>
                                    <textarea id="test-message" class="form-control" v-model="testMessage" placeholder="输入测试消息内容" rows="3"></textarea>
                                </div>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary" @click="testAllChannels" :disabled="!hasChannels">
                                        <i class="bi bi-broadcast-pin me-1"></i> 测试所有渠道
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 右侧渠道列表 -->
                <div class="col-lg-6 col-md-12">
                    <!-- Telegram渠道 -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Telegram渠道</h5>
                        </div>
                        <div class="card-body">
                            <div v-if="channels.telegram.length === 0" class="text-center py-4 text-muted">
                                <i class="bi bi-telegram fs-3 mb-2"></i>
                                <p>暂无Telegram渠道配置</p>
                            </div>
                            <div v-else class="channel-list">
                                <div v-for="(channel, index) in channels.telegram" :key="'telegram-' + index" class="channel-card card mb-3">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <span class="fw-bold">Telegram渠道 {{ index + 1 }}</span>
                                        <div>
                                            <button class="btn btn-sm btn-outline-primary me-1" @click="testChannel('telegram', index)">
                                                <i class="bi bi-send"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-warning me-1" @click="editChannel('telegram', index)">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" @click="deleteChannel('telegram', index)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-2">
                                            <small class="text-muted">Bot Token:</small>
                                            <div class="text-truncate">{{ channel.bot_token || '未配置' }}</div>
                                        </div>
                                        <div class="mb-2">
                                            <small class="text-muted">Chat ID:</small>
                                            <div class="text-truncate">{{ channel.chat_id || '未配置' }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 企业微信渠道 -->
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">企业微信渠道</h5>
                        </div>
                        <div class="card-body">
                            <div v-if="channels.wechat.length === 0" class="text-center py-4 text-muted">
                                <i class="bi bi-wechat fs-3 mb-2"></i>
                                <p>暂无企业微信渠道配置</p>
                            </div>
                            <div v-else class="channel-list">
                                <div v-for="(channel, index) in channels.wechat" :key="'wechat-' + index" class="channel-card card mb-3">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <span class="fw-bold">企业微信渠道 {{ index + 1 }}</span>
                                        <div>
                                            <button class="btn btn-sm btn-outline-primary me-1" @click="testChannel('wechat', index)">
                                                <i class="bi bi-send"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-warning me-1" @click="editChannel('wechat', index)">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" @click="deleteChannel('wechat', index)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-2">
                                            <small class="text-muted">Webhook URL:</small>
                                            <div class="text-truncate">{{ channel.webhook_url || '未配置' }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 消息历史记录 -->
            <div class="mt-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">推送历史记录</h5>
                    </div>
                    <div class="card-body">
                        <div v-if="pushHistory.length === 0" class="text-center py-4 text-muted">
                            <i class="bi bi-clock-history fs-3 mb-2"></i>
                            <p>暂无推送历史记录</p>
                        </div>
                        <div v-else class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>时间</th>
                                        <th>渠道</th>
                                        <th>状态</th>
                                        <th>消息</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr v-for="(record, index) in pushHistory" :key="index">
                                        <td>{{ formatDateTime(record.timestamp) }}</td>
                                        <td>{{ record.channel }}</td>
                                        <td>
                                            <span class="badge" :class="record.status === 'success' ? 'bg-success' : 'bg-danger'">
                                                {{ record.status }}
                                            </span>
                                        </td>
                                        <td class="text-truncate" style="max-width: 300px;">{{ record.message }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 编辑渠道模态框 -->
    <div class="modal fade" id="edit-channel-modal" tabindex="-1" aria-labelledby="edit-channel-modal-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="edit-channel-modal-label">编辑推送渠道</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body">
                    <div v-if="editingChannel.type === 'telegram'">
                        <div class="mb-3">
                            <label for="edit-telegram-bot-token" class="form-label">Bot Token</label>
                            <input type="text" id="edit-telegram-bot-token" class="form-control" v-model="editingChannel.config.bot_token">
                        </div>
                        <div class="mb-3">
                            <label for="edit-telegram-chat-id" class="form-label">Chat ID</label>
                            <input type="text" id="edit-telegram-chat-id" class="form-control" v-model="editingChannel.config.chat_id">
                        </div>
                    </div>
                    <div v-if="editingChannel.type === 'wechat'">
                        <div class="mb-3">
                            <label for="edit-wechat-webhook-url" class="form-label">Webhook URL</label>
                            <input type="text" id="edit-wechat-webhook-url" class="form-control" v-model="editingChannel.config.webhook_url">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" @click="updateChannel">保存更改</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/utils.js"></script>
    <script src="/static/js/toast-utils.js"></script>
    <script src="/static/js/load-navbar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.45/dist/vue.global.js"></script>
    <script>
        const { createApp } = Vue;
        
        createApp({
            data() {
                return {
                    // 新渠道配置
                    newChannel: {
                        type: '',
                        config: {
                            bot_token: '',
                            chat_id: '',
                            webhook_url: ''
                        }
                    },
                    
                    // 编辑渠道配置
                    editingChannel: {
                        type: '',
                        index: -1,
                        config: {}
                    },
                    
                    // 渠道列表
                    channels: {
                        telegram: [],
                        wechat: []
                    },
                    
                    // 测试消息
                    testMessage: '这是一条测试消息，用于验证推送功能是否正常。',
                    
                    // 推送历史
                    pushHistory: [],
                    
                    // 加载状态
                    isLoading: false,
                    loadingMessage: '加载中...',
                    
                    // 模态框实例
                    editModal: null
                }
            },
            
            computed: {
                // 是否可以添加渠道
                canAddChannel() {
                    if (!this.newChannel.type) return false;
                    
                    if (this.newChannel.type === 'telegram') {
                        return this.newChannel.config.bot_token && this.newChannel.config.chat_id;
                    } else if (this.newChannel.type === 'wechat') {
                        return this.newChannel.config.webhook_url;
                    }
                    
                    return false;
                },
                
                // 是否有渠道配置
                hasChannels() {
                    return this.channels.telegram.length > 0 || this.channels.wechat.length > 0;
                }
            },
            
            mounted() {
                // 加载导航栏
                loadNavbar('navbar-container', '/templates/navbar.html');
                
                // 初始化编辑模态框
                this.editModal = new bootstrap.Modal(document.getElementById('edit-channel-modal'));
                
                // 加载配置
                this.loadConfig();
            },
            
            methods: {
                // 加载配置
                async loadConfig() {
                    this.isLoading = true;
                    this.loadingMessage = '加载推送配置...';
                    
                    try {
                        const response = await axios.get('/api/push/config');
                        if (response.data.status === 'success') {
                            this.channels = response.data.channels;
                        }
                    } catch (error) {
                        console.error('加载配置失败:', error);
                        showToast('加载配置失败', 'error');
                    } finally {
                        this.isLoading = false;
                    }
                },
                
                // 添加渠道
                async addChannel() {
                    if (!this.canAddChannel) return;
                    
                    this.isLoading = true;
                    this.loadingMessage = '添加推送渠道...';
                    
                    try {
                        const response = await axios.post('/api/push/add-channel', {
                            channel_type: this.newChannel.type,
                            config: this.newChannel.config
                        });
                        
                        if (response.data.status === 'success') {
                            showToast('渠道添加成功', 'success');
                            this.resetNewChannel();
                            this.loadConfig();
                        } else {
                            showToast('渠道添加失败: ' + response.data.message, 'error');
                        }
                    } catch (error) {
                        console.error('添加渠道失败:', error);
                        showToast('添加渠道失败', 'error');
                    } finally {
                        this.isLoading = false;
                    }
                },
                
                // 重置新渠道表单
                resetNewChannel() {
                    this.newChannel = {
                        type: '',
                        config: {
                            bot_token: '',
                            chat_id: '',
                            webhook_url: ''
                        }
                    };
                },
                
                // 编辑渠道
                editChannel(type, index) {
                    this.editingChannel = {
                        type: type,
                        index: index,
                        config: JSON.parse(JSON.stringify(this.channels[type][index]))
                    };
                    this.editModal.show();
                },
                
                // 更新渠道
                async updateChannel() {
                    this.isLoading = true;
                    this.loadingMessage = '更新推送渠道...';
                    
                    try {
                        const response = await axios.post('/api/push/update-channel', {
                            channel_type: this.editingChannel.type,
                            channel_index: this.editingChannel.index,
                            config: this.editingChannel.config
                        });
                        
                        if (response.data.status === 'success') {
                            showToast('渠道更新成功', 'success');
                            this.editModal.hide();
                            this.loadConfig();
                        } else {
                            showToast('渠道更新失败: ' + response.data.message, 'error');
                        }
                    } catch (error) {
                        console.error('更新渠道失败:', error);
                        showToast('更新渠道失败', 'error');
                    } finally {
                        this.isLoading = false;
                    }
                },
                
                // 删除渠道
                async deleteChannel(type, index) {
                    if (!confirm('确定要删除此推送渠道吗？')) return;
                    
                    this.isLoading = true;
                    this.loadingMessage = '删除推送渠道...';
                    
                    try {
                        const response = await axios.post('/api/push/delete-channel', {
                            channel_type: type,
                            channel_index: index
                        });
                        
                        if (response.data.status === 'success') {
                            showToast('渠道删除成功', 'success');
                            this.loadConfig();
                        } else {
                            showToast('渠道删除失败: ' + response.data.message, 'error');
                        }
                    } catch (error) {
                        console.error('删除渠道失败:', error);
                        showToast('删除渠道失败', 'error');
                    } finally {
                        this.isLoading = false;
                    }
                },
                
                // 测试所有渠道
                async testAllChannels() {
                    this.isLoading = true;
                    this.loadingMessage = '测试所有推送渠道...';
                    
                    try {
                        const response = await axios.post('/api/push/send-all', {
                            message: this.testMessage
                        });
                        
                        if (response.data.status === 'success') {
                            const results = response.data.results;
                            
                            // 更新历史记录
                            results.forEach(result => {
                                this.pushHistory.unshift({
                                    timestamp: Date.now(),
                                    channel: result.channel,
                                    status: result.status,
                                    message: this.testMessage
                                });
                            });
                            
                            // 限制历史记录数量
                            if (this.pushHistory.length > 50) {
                                this.pushHistory = this.pushHistory.slice(0, 50);
                            }
                            
                            showToast('测试消息发送完成', 'success');
                        } else {
                            showToast('测试消息发送失败: ' + response.data.message, 'error');
                        }
                    } catch (error) {
                        console.error('测试渠道失败:', error);
                        showToast('测试渠道失败', 'error');
                    } finally {
                        this.isLoading = false;
                    }
                },
                
                // 测试单个渠道
                async testChannel(type, index) {
                    this.isLoading = true;
                    this.loadingMessage = '测试推送渠道...';
                    
                    try {
                        const response = await axios.post('/api/push/send-to-channel', {
                            channel_type: type,
                            channel_index: index,
                            message: this.testMessage
                        });
                        
                        if (response.data.status === 'success') {
                            // 更新历史记录
                            this.pushHistory.unshift({
                                timestamp: Date.now(),
                                channel: type,
                                status: response.data.status,
                                message: this.testMessage
                            });
                            
                            // 限制历史记录数量
                            if (this.pushHistory.length > 50) {
                                this.pushHistory = this.pushHistory.slice(0, 50);
                            }
                            
                            showToast('测试消息发送成功', 'success');
                        } else {
                            showToast('测试消息发送失败: ' + response.data.message, 'error');
                        }
                    } catch (error) {
                        console.error('测试渠道失败:', error);
                        showToast('测试渠道失败', 'error');
                    } finally {
                        this.isLoading = false;
                    }
                },
                
                // 格式化日期时间
                formatDateTime(timestamp) {
                    const date = new Date(timestamp);
                    return date.toLocaleString('zh-CN');
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
