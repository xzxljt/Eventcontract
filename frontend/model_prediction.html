<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>模型预测系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/css/shared-styles.css">
    <link rel="stylesheet" href="/static/css/model-prediction-styles.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        .model-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .model-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .config-section {
            margin-bottom: 1.5rem;
        }
        .config-section h6 {
            margin-bottom: 0.75rem;
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="navbar-container"></div>
        
        <div class="container mt-4">
            <h1 class="mb-4">模型预测系统</h1>
            
            <!-- 系统状态提示 -->
            <div v-if="isTraining" class="alert alert-info alert-dismissible fade show" role="alert">
                <div class="d-flex align-items-center">
                    <span class="spinner-border spinner-border-sm me-2"></span>
                    <div>
                        <strong>训练任务运行中</strong>
                        <br>
                        <span>{{ trainingStatus }}</span>
                        <br>
                        <small class="text-muted">
                            页面刷新不会影响后台任务运行，您可以随时回来查看进度
                        </small>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <!-- 左侧配置区域 -->
                <div class="col-lg-6 col-md-12">
                    <!-- 模型配置 -->
                    <div class="card model-card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">核心配置</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="model-system" class="form-label">模型系统</label>
                                <select id="model-system" class="form-select" v-model="modelConfig.system">
                                    <option value="single">单个模型</option>
                                    <option value="ensemble" selected>集成模型</option>
                                </select>
                            </div>
                            
                            <!-- 单个模型配置 -->
                            <div id="single-model-config" class="mb-3">
                                <label for="single-model-type" class="form-label">模型类型</label>
                                <select id="single-model-type" class="form-select" v-model="modelConfig.singleModelType">
                                    <option value="random_forest">随机森林</option>
                                    <option value="xgboost">XGBoost</option>
                                </select>
                            </div>
                            
                            <!-- 集成模型配置 -->
                            <div id="ensemble-model-config" class="mb-3">
                                <label for="model-count" class="form-label">模型数量</label>
                                <input type="number" id="model-count" class="form-control" v-model.number="modelConfig.modelCount" min="1" max="5">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 模型参数配置 -->
                    <div class="card model-card mt-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">模型参数配置</h5>
                        </div>
                        <div class="card-body">
                            <div class="config-section">
                                <h6>随机森林参数</h6>
                                <div class="mb-2">
                                    <label class="form-label small">n_estimators</label>
                                    <input type="number" class="form-control form-control-sm" v-model.number="modelConfig.randomForestParams.n_estimators" min="10" max="500">
                                </div>
                                <div class="mb-2">
                                    <label class="form-label small">max_depth</label>
                                    <input type="number" class="form-control form-control-sm" v-model.number="modelConfig.randomForestParams.max_depth" min="1" max="50">
                                </div>
                            </div>
                            
                            <div class="config-section">
                                <h6>XGBoost参数</h6>
                                <div class="mb-2">
                                    <label class="form-label small">n_estimators</label>
                                    <input type="number" class="form-control form-control-sm" v-model.number="modelConfig.xgboostParams.n_estimators" min="10" max="500">
                                </div>
                                <div class="mb-2">
                                    <label class="form-label small">learning_rate</label>
                                    <input type="number" class="form-control form-control-sm" v-model.number="modelConfig.xgboostParams.learning_rate" min="0.01" max="1" step="0.01">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 操作按钮 -->
                    <div class="card model-card mt-4">
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button id="start-training" class="btn btn-primary btn-lg" @click="startTraining" :disabled="isTraining">
                                    <span v-if="isTraining" class="spinner-border spinner-border-sm me-2"></span>
                                    {{ isTraining ? '训练中...' : '开始训练' }}
                                </button>
                                <button class="btn btn-secondary btn-lg" @click="saveConfig">
                                    <i class="bi bi-save me-1"></i> 保存配置
                                </button>
                                <button class="btn btn-outline-info btn-lg" @click="loadConfig">
                                    <i class="bi bi-download me-1"></i> 加载配置
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 右侧核心控制区域 -->
                <div class="col-lg-6 col-md-12">
                    <!-- 训练状态 -->
                    <div class="card model-card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">训练状态</h5>
                        </div>
                        <div class="card-body">
                            <div id="training-status">
                                <div class="mb-3">
                                    <span class="fw-bold">状态:</span>
                                    <span id="training-status-text" class="ms-2">{{ trainingStatus }}</span>
                                </div>
                                <div class="mb-3">
                                    <span class="fw-bold">进度:</span>
                                    <div class="progress mt-2">
                                        <div id="progress-fill" class="progress-bar bg-success" role="progressbar" :style="{width: trainingProgress + '%'}" :aria-valuenow="trainingProgress" aria-valuemin="0" aria-valuemax="100">
                                            <span id="progress-percent">{{ trainingProgress }}%</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <span class="fw-bold">训练日志:</span>
                                    <div id="training-log" class="mt-2 p-3 bg-light rounded border" style="max-height: 200px; overflow-y: auto;">
                                        <p v-for="(log, index) in trainingLogs" :key="index" class="mb-1">{{ log }}</p>
                                        <p v-if="!trainingLogs.length">训练日志将显示在这里...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 模型状态 -->
                    <div class="card model-card mt-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">模型状态</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="small text-muted">模型数量</div>
                                    <div class="h4">{{ modelStatus.modelCount }}</div>
                                </div>
                                <div class="col-6">
                                    <div class="small text-muted">状态</div>
                                    <div class="h4" :class="modelStatus.isTrained ? 'text-success' : 'text-warning'">
                                        {{ modelStatus.isTrained ? '已训练' : '未训练' }}
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="small text-muted">最后训练时间</div>
                                <div>{{ modelStatus.lastTrained || '从未训练' }}</div>
                            </div>
                            <div class="mt-3">
                                <div class="small text-muted">模型类型</div>
                                <div>{{ modelStatus.modelTypes.join(', ') }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="/static/js/load-navbar.js"></script>
    <script>
        const { createApp } = Vue;
        
        createApp({
            data() {
                return {
                    // 模型配置
                    modelConfig: {
                        system: 'ensemble',
                        singleModelType: 'random_forest',
                        modelCount: 2,
                        randomForestParams: {
                            n_estimators: 100,
                            max_depth: 10
                        },
                        xgboostParams: {
                            n_estimators: 100,
                            learning_rate: 0.1
                        }
                    },
                    
                    // 训练状态
                    isTraining: false,
                    trainingStatus: '就绪',
                    trainingProgress: 0,
                    trainingLogs: [],
                    
                    // 模型状态
                    modelStatus: {
                        modelCount: 0,
                        isTrained: false,
                        lastTrained: null,
                        modelTypes: []
                    }
                }
            },
            
            mounted() {
                loadNavbar('navbar-container', '/templates/navbar.html');
                this.loadModelStatus();
                this.loadSavedConfig();
            },
            
            methods: {
                startTraining() {
                    this.isTraining = true;
                    this.trainingStatus = '准备训练...';
                    this.trainingProgress = 0;
                    this.trainingLogs = [];
                    
                    // 构建训练请求数据
                    const trainingData = {
                        model_system: this.modelConfig.system,
                        model_type: this.modelConfig.singleModelType,
                        model_count: this.modelConfig.modelCount,
                        model_params: {
                            random_forest: this.modelConfig.randomForestParams,
                            xgboost: this.modelConfig.xgboostParams
                        }
                    };
                    
                    // 发送训练请求
                    fetch('/api/prediction/run', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(trainingData)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            this.trainingStatus = '训练任务已启动';
                            this.trainingLogs.push('训练任务已启动');
                            this.trainingLogs.push('模型预测完成');
                            this.trainingProgress = 100;
                            this.trainingStatus = '训练完成';
                            this.isTraining = false;
                            this.loadModelStatus();
                        } else {
                            this.trainingStatus = '训练启动失败: ' + (data.message || '未知错误');
                            this.trainingLogs.push('训练启动失败: ' + (data.message || '未知错误'));
                            this.isTraining = false;
                        }
                    })
                    .catch(error => {
                        this.trainingStatus = '训练启动失败: ' + (error.message || '网络错误');
                        this.trainingLogs.push('训练启动失败: ' + (error.message || '网络错误'));
                        this.isTraining = false;
                    });
                },
                
                saveConfig() {
                    // 保存配置到本地存储
                    localStorage.setItem('model_prediction_config', JSON.stringify(this.modelConfig));
                    alert('配置已保存');
                },
                
                loadConfig() {
                    // 从本地存储加载配置
                    const savedConfig = localStorage.getItem('model_prediction_config');
                    if (savedConfig) {
                        this.modelConfig = JSON.parse(savedConfig);
                        alert('配置已加载');
                    } else {
                        alert('没有找到保存的配置');
                    }
                },
                
                loadSavedConfig() {
                    // 页面加载时从本地存储加载配置
                    const savedConfig = localStorage.getItem('model_prediction_config');
                    if (savedConfig) {
                        this.modelConfig = JSON.parse(savedConfig);
                    }
                },
                
                loadModelStatus() {
                    // 加载模型状态
                    fetch('/api/prediction/status')
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            this.modelStatus = {
                                modelCount: data.model_count || 0,
                                isTrained: data.is_trained || false,
                                lastTrained: data.last_trained || null,
                                modelTypes: data.model_types || []
                            };
                        }
                    })
                    .catch(error => {
                        console.error('获取模型状态失败:', error);
                    });
                }
            },
            
            watch: {
                'modelConfig.system'() {
                    // 模型系统变化时的处理
                }
            }
        }).mount('#app');
    </script>
</body>
</html>